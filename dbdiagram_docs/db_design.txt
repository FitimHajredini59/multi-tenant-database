Enum tenant_status {
  active
  suspended
  inactive
}

Enum order_status {
   pending
   processing
   shipped
   completed
   cancelled
}

Enum payment_status {
  pending
  successful
  failed
}

Enum payment_method {
  mastercard
  visa
  american_express
  paypal
  cash
}

Enum shipment_status {
  pending
  packed
  shipped
  delivered
  returned
  cancelled
}

Table tenants {
  id integer [primary key, increment]
  domain varchar [not null, unique]
  status tenant_status [default: 'active']
  created_at timestamp [default: `now()`]
  updated_at timestamp
  deleted_at timestamp
}

Table users {
  id integer [primary key, increment]
  tenant_id integer [not null]
  role_id integer [not null]
  name varchar
  email varchar [not null]
  password_hash varchar [not null]
  created_at timestamp [default: `now()`]
  updated_at timestamp
  deleted_at timestamp

  Indexes {
    (tenant_id, id) [unique]
    (tenant_id, email) [unique]
  }
}

Table roles {
  id integer [primary key, increment]
  tenant_id integer [not null]
  name varchar [not null]

  Indexes {
    (tenant_id, id) [unique]
    (tenant_id, name) [unique]
  }
}

Table permissions {
  id integer [primary key, increment]
  tenant_id integer [not null]
  name varchar [not null]
  
  Indexes {
    (tenant_id, id) [unique]
    (tenant_id, name) [unique]
  }
}

Table role_permissions {
  role_id integer [not null]
  permission_id integer [not null]
  tenant_id integer [not null]

  Indexes {
    (tenant_id, role_id, permission_id) [pk]
  }
}

Table pages {
  id integer [primary key, increment]
  tenant_id integer [not null]
  slug varchar [not null]
  created_at timestamp [default: `now()`]
  updated_at timestamp

  Indexes {
    (tenant_id, id) [unique]
    (tenant_id, slug) [unique]
  }
}

Table page_sections {
  id integer [primary key, increment]
  page_id integer [not null]
  tenant_id integer [not null]
  content text
  metadata jsonb
  created_at timestamp [default: `now()`]
  updated_at timestamp

  Indexes {
    (tenant_id, id) [unique]
  }

}

Table page_files {
  id integer [primary key, increment]
  tenant_id integer [not null]
  page_id integer [not null]
  path varchar
  metadata jsonb
  created_at timestamp [default: `now()`]
  updated_at timestamp
}

Table forms {
  id integer [primary key, increment]
  tenant_id integer [not null]
  page_id integer
  title varchar
  slug varchar [not null, note: "Enables embedding a form in multiple pages"]
  metadata jsonb
  created_at timestamp [default: `now()`]
  updated_at timestamp

  indexes {
    (tenant_id, id) [unique]
    (tenant_id, slug) [unique]
  }
}

Table questions {
  id integer [primary key, increment]
  tenant_id integer [not null]
  form_id integer [not null]
  is_required bool
  value text [note: "The actual question"]
  position integer
  metadata jsonb
  created_at timestamp [default: `now()`]
  updated_at timestamp

  indexes {
    (tenant_id, id) [unique]
  }
}

Table form_submissions {
  id integer [primary key, increment]
  tenant_id integer [not null]
  user_id integer [not null]
  form_id integer [not null]
  metadata jsonb
  created_at timestamp [default: `now()`]
  updated_at timestamp

  indexes {
    (tenant_id, id) [unique]
  }
}

Table answers {
  id integer [primary key, increment]
  tenant_id integer [not null]
  question_id integer [not null]
  submission_id integer [not null]
  value text [note: "The actual answer"]
  metadata jsonb
  created_at timestamp [default: `now()`]
  updated_at timestamp

  Indexes {
    (tenant_id, id) [unique]
    (submission_id, question_id) [unique] // Allows the same user to answer the same question again in a new submission, because the submission_id is different
  }
}

Table patients {
  id integer [primary key, increment]
  user_id integer [not null]
  tenant_id integer [not null]
  birthdate date [not null]
  gender varchar
  phone_number varchar
  clinical_history jsonb [note: "Optional patient history such as previous illnesses, allergies, smoking, alcohol or other patient info"]

  Indexes {
    (tenant_id, id) [unique]
    (tenant_id, user_id) [unique]
  }
}

Table consultations {
  id integer [primary key, increment]
  tenant_id integer [not null]
  patient_id integer [not null]
  doctor_id integer [not null]
  form_id integer
  symptoms varchar
  current_medications varchar
  diagnosis varchar
  tests varchar [note: "Medical examinations necessary to diagnose a patient"]
  created_at timestamp [default: `now()`]
  updated_at timestamp

  indexes {
    (tenant_id, id) [unique]
  }
}

Table products {
  id integer [primary key, increment]
  tenant_id integer [not null]
  slug varchar [not null]
  title varchar
  description text
  price decimal [check: `price >= 0`]
  prescription_required bool
  image varchar
  stock_quantity integer [check: `stock_quantity >= 0`]
  created_at timestamp [default: `now()`]
  updated_at timestamp
  deleted_at timestamp

  indexes {
    (tenant_id, id) [unique]
    (tenant_id, slug) [unique]
  }
}

Table prescriptions {
  id integer [primary key, increment]
  tenant_id integer [not null]
  consultation_id integer [not null]
  usage_instructions varchar
  other_medications varchar
  created_at timestamp [default: `now()`]
  updated_at timestamp

  indexes {
    (tenant_id, id) [unique]
  }
}

Table categories {
  id integer [primary key, increment]
  tenant_id integer [not null]
  parent_id integer
  name varchar
  slug varchar [not null]
  description text

  indexes {
    (tenant_id, id) [unique]
    (tenant_id, slug) [unique]
  }
}

Table prescription_products {
  prescription_id integer [not null]
  product_id integer [not null]
  tenant_id integer [not null]

  Indexes {
    (tenant_id, prescription_id, product_id) [pk]
  }
}

Table product_categories {
  product_id integer [not null]
  category_id integer [not null]
  tenant_id integer [not null]

  Indexes {
    (tenant_id, product_id, category_id) [pk]
  }
}

Table orders {
  id integer [primary key, increment]
  user_id integer [not null]
  tenant_id integer [not null]
  status order_status [not null, default: 'pending']
  total_amount decimal [not null]
  shipping_address varchar [not null]
  billing_address varchar
  created_at timestamp [default: `now()`]
  updated_at timestamp
  deleted_at timestamp

  indexes {
    (tenant_id, id) [unique]
  }
}

Table shipments {
  id integer [primary key, increment]
  tenant_id integer [not null]
  order_id integer [not null]
  status shipment_status [not null, default: 'pending']
  carrier varchar
  tracking_number varchar
  recipient_name varchar [not null]
  address_line1 varchar [not null]
  address_line2 varchar
  city varchar [not null]
  state varchar
  postal_code varchar [not null]
  country_code varchar [not null, note: "ISO-3166 alpha-2 recommended"]
  shipped_at timestamp
  delivered_at timestamp
  created_at timestamp [default: `now()`]
  updated_at timestamp

  Indexes {
    (tenant_id, id) [unique]
    (tenant_id, order_id)
    (tenant_id, tracking_number)
  }
}

Table order_items {
  id integer [primary key, increment]
  tenant_id integer [not null]
  order_id int [not null]
  product_id int [not null]
  quantity int [not null, check: `quantity > 0`]

  indexes {
    (tenant_id, id) [unique]
  }
}

Table payments {
  id integer [primary key, increment]
  order_id integer [not null]
  tenant_id integer [not null]
  payment_method payment_method [not null]
  status payment_status [default: 'pending']
  amount decimal [not null]
  transaction_id varchar [note: "Foreign transaction ID from a third party service"]
  created_at timestamp [default: `now()`]
  updated_at timestamp
}

Ref: tenants.id < users.tenant_id

Ref: roles.tenant_id > tenants.id
Ref: roles.(tenant_id, id) < users.(tenant_id, role_id)

Ref: permissions.tenant_id > tenants.id

Ref: role_permissions.(tenant_id, role_id) > roles.(tenant_id, id)
Ref: role_permissions.(tenant_id, permission_id) > permissions.(tenant_id, id)
Ref: role_permissions.tenant_id > tenants.id

Ref: pages.tenant_id > tenants.id

Ref: page_sections.(tenant_id, page_id) > pages.(tenant_id, id)
Ref: page_sections.tenant_id > tenants.id

Ref: page_files.tenant_id > tenants.id
Ref: page_files.(tenant_id, page_id) > pages.(tenant_id, id)

Ref: forms.tenant_id > tenants.id
Ref: forms.(tenant_id, page_id) > pages.(tenant_id, id)

Ref: questions.(tenant_id, form_id) > forms.(tenant_id, id)
Ref: questions.tenant_id > tenants.id

Ref: form_submissions.tenant_id > tenants.id
Ref: form_submissions.(tenant_id, user_id) > users.(tenant_id, id)
Ref: form_submissions.(tenant_id, form_id) > forms.(tenant_id, id)

Ref: answers.tenant_id > tenants.id
Ref: answers.(tenant_id, question_id) > questions.(tenant_id, id)
Ref: answers.(tenant_id, submission_id) > form_submissions.(tenant_id, id)

Ref: patients.(tenant_id, user_id) > users.(tenant_id, id)
Ref: patients.tenant_id > tenants.id

Ref: consultations.tenant_id > tenants.id
Ref: consultations.(tenant_id, patient_id) > patients.(tenant_id, id)
Ref: consultations.(tenant_id, doctor_id) > users.(tenant_id, id)
Ref: consultations.(tenant_id, form_id) > forms.(tenant_id, id)

Ref: prescriptions.tenant_id > tenants.id
Ref: prescriptions.(tenant_id, consultation_id) - consultations.(tenant_id, id)

Ref: products.tenant_id > tenants.id

Ref: prescription_products.tenant_id > tenants.id
Ref: prescription_products.(tenant_id, prescription_id) > prescriptions.(tenant_id, id)
Ref: prescription_products.(tenant_id, product_id) > products.(tenant_id, id)

Ref: categories.tenant_id > tenants.id
Ref: categories.(tenant_id, parent_id) > categories.(tenant_id, id)

Ref: product_categories.tenant_id > tenants.id
Ref: product_categories.(tenant_id, product_id) > products.(tenant_id, id)
Ref: product_categories.(tenant_id, category_id) > categories.(tenant_id, id)

Ref: orders.tenant_id > tenants.id
Ref: orders.(tenant_id, user_id) > users.(tenant_id, id)

Ref: shipments.tenant_id > tenants.id
Ref: shipments.(tenant_id, order_id) > orders.(tenant_id, id)

Ref: order_items.tenant_id > tenants.id
Ref: order_items.(tenant_id, order_id) > orders.(tenant_id, id)
Ref: order_items.(tenant_id, product_id) > products.(tenant_id, id)

Ref: payments.tenant_id > tenants.id
Ref: payments.(tenant_id, order_id) - orders.(tenant_id, id)
